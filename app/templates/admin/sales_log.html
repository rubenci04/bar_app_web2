{% extends "layout.html" %}
{% block content %}
<h1 class="text-3xl font-bold mb-6 text-slate-100">Registro de Ventas</h1>

<div class="bg-slate-800 p-4 rounded-lg shadow-md mb-6">
    <form method="GET" action="{{ url_for('admin.sales_log') }}" class="flex flex-col sm:flex-row items-end gap-3">
        <div class="flex-grow w-full sm:w-auto">
            <label for="date" class="block text-sm font-medium text-slate-300 mb-1">Filtrar por Fecha</label>
            <input type="date" id="date" name="date" value="{{ date_filter or '' }}"
                   class="block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:ring-2 focus:ring-amber-500 transition">
        </div>
        <button type="submit" class="w-full sm:w-auto px-4 py-2 rounded-lg font-semibold bg-amber-600 hover:bg-amber-700 transition-colors text-white">Filtrar</button>
        {% if date_filter %}
        <a href="{{ url_for('admin.sales_log') }}" class="w-full sm:w-auto text-center px-4 py-2 rounded-lg font-semibold bg-slate-600 hover:bg-slate-500 transition-colors text-white">Limpiar</a>
        {% endif %}
    </form>
</div>

<div class="bg-slate-800 p-6 rounded-lg shadow-md mb-6">
    <h2 class="text-xl font-semibold text-slate-100 mb-4">
        Resumen de Ventas {% if date_filter %} del {{ date_filter }} {% else %} (Total Histórico) {% endif %}
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div>
            <p class="text-sm text-slate-400">Ventas en Mesas</p>
            <p class="text-2xl font-bold text-emerald-400">${{ "%.2f"|format(total_sales_table) }}</p>
        </div>
        <div>
            <p class="text-sm text-slate-400">Ventas para Llevar</p>
            <p class="text-2xl font-bold text-emerald-400">${{ "%.2f"|format(total_sales_takeaway) }}</p>
        </div>
        <div class="md:border-l-2 border-slate-700">
            <p class="text-sm text-slate-400">TOTAL VENTAS</p>
            <p class="text-2xl font-bold text-amber-500">${{ "%.2f"|format(total_sales) }}</p>
        </div>
    </div>
</div>

<div class="bg-slate-800 shadow-lg rounded-lg overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-700">
        <thead class="bg-slate-700/50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Tipo / Detalle</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Fecha</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Método Pago</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Total</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-300 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-300 uppercase tracking-wider">Acciones</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
            {% for sale_order in pagination.items %} 
            <tr class="hover:bg-slate-700/50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-100">
                    <a href="{{ url_for('admin.sale_detail_view', order_id=sale_order.id, page=pagination.page, date=date_filter) }}" class="text-amber-500 hover:text-amber-400 hover:underline">
                        #{{ sale_order.id }}
                    </a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                    {{ sale_order.type }} 
                    <span class="text-slate-400">
                        ({% if sale_order.type == 'Mesa' %}Mesa {{ sale_order.table_assigned.number if sale_order.table_assigned else 'N/A' }}{% else %}{{ sale_order.customer_name }}{% endif %})
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">{{ sale_order.updated_at.strftime('%d/%m/%Y %H:%M') }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{{ sale_order.payment_method or 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-100 text-right">${{ "%.2f"|format(sale_order.total_amount) }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                     <span class="px-2.5 py-1 text-xs font-semibold rounded-full 
                        {% if sale_order.status == 'Pagado' %}bg-emerald-500/20 text-emerald-300
                        {% elif sale_order.status == 'Venta Anulada' %}bg-red-500/20 text-red-300
                        {% endif %}">
                        {{ sale_order.status }}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
                    {% if sale_order.status == 'Pagado' %}
                    <form action="{{ url_for('admin.annul_sale', order_id=sale_order.id) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Seguro que quieres ANULAR esta venta (Pedido #{{sale_order.id}})? El stock será repuesto.');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="page" value="{{ pagination.page }}">
                        <input type="hidden" name="date" value="{{ date_filter or '' }}">
                        <button type="submit" class="text-yellow-500 hover:text-yellow-400 transition-colors">Anular</button>
                    </form>
                    {% else %}
                     <span class="text-xs text-slate-500 italic">(Anulada)</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="px-6 py-10 text-center text-sm text-slate-500">No se encontraron ventas para este período.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination and pagination.pages > 1 %}
<div class="mt-6 flex justify-between items-center text-sm">
    <p class="text-slate-400">
        Página {{ pagination.page }} de {{ pagination.pages }}.
    </p>
    <nav class="flex rounded-md shadow-sm" aria-label="Pagination">
        <a href="{{ url_for('admin.sales_log', page=pagination.prev_num, date=date_filter) if pagination.has_prev else '#' }}" 
           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-slate-700 bg-slate-800 font-medium text-slate-400 hover:bg-slate-700
                  {% if not pagination.has_prev %}pointer-events-none text-slate-600{% endif %}">
            Anterior
        </a>
        <a href="{{ url_for('admin.sales_log', page=pagination.next_num, date=date_filter) if pagination.has_next else '#' }}" 
           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-slate-700 bg-slate-800 font-medium text-slate-400 hover:bg-slate-700
                  {% if not pagination.has_next %}pointer-events-none text-slate-600{% endif %}">
            Siguiente
        </a>
    </nav>
</div>
{% endif %}
{% endblock %}