{% extends "layout.html" %}
{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-slate-100">Gestionar Mesas</h1>
</div>

<div class="bg-slate-800 p-6 rounded-lg shadow-md mb-8">
    <h2 class="text-xl font-semibold text-amber-500 mb-4">Añadir Nueva Mesa</h2>
    <form method="POST" action="{{ url_for('admin.add_table') }}" id="addTableForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label for="add_number" class="block text-sm font-medium text-slate-300 mb-1">Número de Mesa</label>
            <input type="number" name="number" id="add_number" min="1" required
                   class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:ring-2 focus:ring-amber-500 transition">
        </div>
        <div>
            <label for="add_capacity" class="block text-sm font-medium text-slate-300 mb-1">Capacidad</label>
            <input type="number" name="capacity" id="add_capacity" min="1" required
                   class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:ring-2 focus:ring-amber-500 transition">
        </div>
        <div class="md:col-span-2">
            <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg font-semibold bg-amber-600 hover:bg-amber-700 transition-colors text-white">Añadir Mesa</button>
        </div>
    </form>
</div>

<div class="bg-slate-800 shadow-lg rounded-lg overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-700">
        <thead class="bg-slate-700/50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Número</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Capacidad</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Estado Actual</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-slate-300 uppercase tracking-wider">Acciones</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
            {% for table_item in tables_on_page %}
            <tr class="hover:bg-slate-700/50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-100">{{ table_item.number }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{{ table_item.capacity }} personas</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">{{ table_item.status }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center space-x-4">
                    <button type="button" class="text-amber-500 hover:text-amber-400 transition-colors"
                            onclick="openEditModal({{ table_item.id }}, {{ table_item.number }}, {{ table_item.capacity }})">
                        Editar
                    </button>
                    <form action="{{ url_for('admin.delete_table', table_id=table_item.id) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Seguro que quieres eliminar la Mesa {{ table_item.number }}?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="page" value="{{ pagination.page }}">
                        <button type="submit" class="text-red-500 hover:text-red-400 transition-colors disabled:text-slate-600 disabled:cursor-not-allowed"
                                {% if table_item.status != 'Vacía' %}disabled title="No se puede eliminar una mesa ocupada"{% endif %}>
                            Eliminar
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="px-6 py-10 text-center text-sm text-slate-500">No hay mesas configuradas.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination and pagination.pages > 1 %}
<div class="mt-6 flex justify-center">
    <nav class="flex rounded-md shadow-sm" aria-label="Pagination">
        <a href="{{ url_for('admin.manage_tables', page=pagination.prev_num if pagination.has_prev else '#') }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-slate-700 bg-slate-800 text-sm font-medium text-slate-400 hover:bg-slate-700 {% if not pagination.has_prev %}pointer-events-none text-slate-600{% endif %}">Anterior</a>
        <span class="relative inline-flex items-center px-4 py-2 border-t border-b border-slate-700 bg-slate-800 text-sm font-medium text-slate-300">Página {{ pagination.page }} de {{ pagination.pages }}</span>
        <a href="{{ url_for('admin.manage_tables', page=pagination.next_num if pagination.has_next else '#') }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-slate-700 bg-slate-800 text-sm font-medium text-slate-400 hover:bg-slate-700 {% if not pagination.has_next %}pointer-events-none text-slate-600{% endif %}">Siguiente</a>
    </nav>
</div>
{% endif %}

<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
        <h3 id="edit-modal-title" class="text-xl font-bold text-slate-100 mb-6">Editar Mesa</h3>
        <form id="edit-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="page" value="{{ pagination.page }}">
            <div class="space-y-4">
                <div>
                    <label for="edit_number" class="block text-sm font-medium text-slate-300">Número de Mesa</label>
                    <input type="number" name="number" id="edit_number" min="1" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:ring-2 focus:ring-amber-500 transition">
                </div>
                <div>
                    <label for="edit_capacity" class="block text-sm font-medium text-slate-300">Capacidad</label>
                    <input type="number" name="capacity" id="edit_capacity" min="1" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:ring-2 focus:ring-amber-500 transition">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="close-edit-modal-btn" class="px-4 py-2 rounded-lg font-semibold bg-slate-600 hover:bg-slate-700 transition-colors text-white">Cancelar</button>
                <button type="submit" class="px-4 py-2 rounded-lg font-semibold bg-amber-600 hover:bg-amber-700 transition-colors text-white">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('edit-modal');
    const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    const editForm = document.getElementById('edit-form');
    const editModalTitle = document.getElementById('edit-modal-title');
    const editNumberInput = document.getElementById('edit_number');
    const editCapacityInput = document.getElementById('edit_capacity');

    window.openEditModal = function(tableId, tableNumber, tableCapacity) {
        editForm.action = `/admin/tables/edit/${tableId}`;
        editModalTitle.textContent = `Editar Mesa #${tableNumber}`;
        editNumberInput.value = tableNumber;
        editCapacityInput.value = tableCapacity;
        editModal.classList.remove('hidden');
    };

    if (editModal && closeEditModalBtn) {
        closeEditModalBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.add('hidden');
            }
        });
    }
});
</script>
{% endblock %}