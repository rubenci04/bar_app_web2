{% extends "layout.html" %}
{% block content %}
<input type="hidden" id="csrf_token_js" value="{{ csrf_token_value }}">

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-brand-primary">{{ action }} Pedido Llevar {% if order %}(ID: {{ order.id }}){% endif %}</h1>
    <a href="{{ url_for('mozo.takeaway_orders_view') }}" class="btn btn-black px-4 py-2">Volver a Lista</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-1 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-gray-100">Detalles del Pedido</h2>
        <form method="POST" action="{{ url_for('mozo.takeaway_order_detail', order_id=order.id) if order else url_for('mozo.new_takeaway_order') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
            <div class="mb-4">
                <label for="customer_name" class="block text-sm font-medium text-gray-300">Nombre del Cliente</label>
                <input type="text" name="customer_name" id="customer_name" value="{{ order.customer_name if order else '' }}" {% if not order %}required{% endif %} class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
            </div>
            {% if not order %}
                <button type="submit" class="w-full btn btn-orange px-4 py-2 mb-3">Crear Pedido</button>
            {% else %}
                <button type="submit" class="w-full btn btn-orange px-4 py-2 mb-3">Actualizar Nombre</button>
            {% endif %}
        </form>

        {% if order and order.status == 'Pendiente' %}
        <div class="mt-6 border-t border-gray-700 pt-4 space-y-2">
            <form action="{{ url_for('mozo.mark_order_paid', order_id=order.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
                <button type="submit" class="w-full btn btn-orange px-4 py-2 {% if not order.items %}btn-disabled{% endif %}" {% if not order.items %}disabled{% endif %}>Marcar como Pagado</button>
            </form>
            <form action="{{ url_for('mozo.cancel_order', order_id=order.id) }}" method="POST" onsubmit="return confirm('¿Seguro que quieres cancelar este pedido?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
                <button type="submit" class="w-full btn btn-danger px-4 py-2">Cancelar Pedido</button>
            </form>
        </div>
        {% endif %}
    </div>

    {% if order %}
    <div class="md:col-span-2 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4 text-gray-100">Ítems del Pedido</h2>
        <div id="order-items-list" class="mb-4 border-t border-b border-gray-700 divide-y divide-gray-700">
            {% for item in order.items %}
            <div id="item-row-{{ item.id }}" class="py-3 flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-100">{{ item.product.name }}</p>
                    <p class="text-sm text-gray-400">{{ item.quantity }} x ${{ "%.2f"|format(item.unit_price) }}</p>
                </div>
                <div class="text-right">
                    <p class="font-medium text-gray-100">${{ "%.2f"|format(item.subtotal) }}</p>
                    <button onclick="removeItem({{ item.id }}, {{ item.product.name | tojson }})" class="text-xs text-red-400 hover:text-red-300">Quitar</button>
                </div>
            </div>
            {% endfor %}
            {% if not order.items %}
            <p id="no-items-message" class="text-gray-500 py-3">No hay ítems en este pedido.</p>
            {% endif %}
        </div>
        <div class="text-right mb-6">
            <p class="text-xl font-bold text-gray-100">Total: <span id="order-total">${{ "%.2f"|format(order.total_amount) }}</span></p>
        </div>
        
        <div class="border-t border-gray-700 pt-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-100">Añadir Productos</h3>
            <form id="add-item-form" class="space-y-4">
                <div>
                    <label for="product_id" class="block text-sm font-medium text-gray-300">Producto</label>
                    <select name="product_id" id="product_id" required class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                        <option value="">Selecciona un producto...</option>
                        {% for type, products_in_type in products_by_category.items() %}
                        <optgroup label="{{ type }}">
                            {% for product in products_in_type %}
                            <option value="{{ product.id }}" data-stock="{{ product.stock }}">{{ product.name }} - ${{ "%.2f"|format(product.price) }} (Stock: {{ product.stock }})</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-300">Cantidad</label>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                </div>
                <button type="submit" class="w-full btn btn-orange px-4 py-2">Añadir al Pedido</button>
            </form>
            <div id="add-item-message" class="mt-3 text-sm"></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.getElementById('csrf_token_js').value;

    function showJsMessage(message, type = 'info') {
        const messageDiv = document.getElementById('add-item-message');
        if (!messageDiv) return;
        messageDiv.textContent = message;
        messageDiv.className = 'p-3 my-3 text-sm rounded-md ';
        if (type === 'success') messageDiv.classList.add('bg-green-200', 'text-green-800', 'border', 'border-green-400');
        else messageDiv.classList.add('bg-red-200', 'text-red-800', 'border', 'border-red-400');
        setTimeout(() => { messageDiv.textContent = ''; messageDiv.className = 'mt-3 text-sm'; }, 4000);
    }

    function updateOrderView(item, newTotal) {
        const list = document.getElementById('order-items-list');
        const totalEl = document.getElementById('order-total');
        const noItemsMsg = document.getElementById('no-items-message');
        if (noItemsMsg) noItemsMsg.remove();

        let row = document.getElementById(`item-row-${item.id}`);
        if (row) {
            row.querySelector('.text-sm').textContent = `${item.quantity} x $${item.unit_price.toFixed(2)}`;
            row.querySelector('.text-right .font-medium').textContent = `$${item.subtotal.toFixed(2)}`;
        } else {
            row = document.createElement('div');
            row.id = `item-row-${item.id}`;
            row.className = 'py-3 flex justify-between items-center';
            row.innerHTML = `
                <div>
                    <p class="font-medium text-gray-100">${item.name}</p>
                    <p class="text-sm text-gray-400">${item.quantity} x $${item.unit_price.toFixed(2)}</p>
                </div>
                <div class="text-right">
                    <p class="font-medium text-gray-100">$${item.subtotal.toFixed(2)}</p>
                    <button onclick="removeItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')" class="text-xs text-red-400 hover:text-red-300">Quitar</button>
                </div>`;
            list.appendChild(row);
        }
        totalEl.textContent = `$${newTotal.toFixed(2)}`;
    }

    window.removeItem = function(itemId, itemName) {
        if (!confirm(`¿Seguro que quieres quitar ${itemName} del pedido?`)) return;
        const formData = new FormData();
        formData.append('csrf_token', csrfToken);
        fetch(`/mozo/order_item/${itemId}/remove`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`item-row-${itemId}`);
                if (row) row.remove();
                document.getElementById('order-total').textContent = `$${data.order_total.toFixed(2)}`;
                showJsMessage(data.message, 'success');
                const list = document.getElementById('order-items-list');
                if (!list.querySelector('div[id^="item-row-"]')) {
                    list.innerHTML = '<p id="no-items-message" class="text-gray-500 py-3">No hay ítems en este pedido.</p>';
                }
            } else { showJsMessage(data.message, 'error'); }
        });
    }
    
    const addItemForm = document.getElementById('add-item-form');
    if (addItemForm) {
        addItemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append('csrf_token', csrfToken);
            const fetchUrl = `{{ url_for('mozo.add_item_to_order', order_id=(order.id if order else 0)) }}`;
            fetch(fetchUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateOrderView(data.item, data.order_total);
                    showJsMessage(data.message, 'success');
                    this.reset();
                    document.getElementById('quantity').value = 1;
                } else { showJsMessage(data.message, 'error'); }
            });
        });
    }
});
</script>
{% endblock %}