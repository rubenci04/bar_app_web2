{% extends "layout.html" %}
{% block content %}
<input type="hidden" id="csrf_token_js" value="{{ csrf_token_value }}">

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-brand-primary">Mesa {{ table.number }} <span class="text-lg font-normal text-gray-300">({{ table.status }})</span></h1>
    <a href="{{ url_for('mozo.tables_view') }}" class="btn btn-black px-4 py-2">Volver a Mesas</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-2 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4 text-gray-100">Pedido Actual</h2>
        {% if current_order %}
            <p class="mb-4 text-gray-300">ID Pedido: {{ current_order.id }}</p>
            <div id="order-items-list" class="mb-4 border-t border-b border-gray-700 divide-y divide-gray-700">
                {% for item in current_order.items %}
                <div id="item-row-{{ item.id }}" class="py-3 flex justify-between items-center">
                    <div>
                        <p class="font-medium text-gray-100">{{ item.product.name }}</p>
                        <p class="text-sm text-gray-400">{{ item.quantity }} x ${{ "%.2f"|format(item.unit_price) }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium text-gray-100">${{ "%.2f"|format(item.subtotal) }}</p>
                        <button onclick="removeItem({{ item.id }}, {{ item.product.name | tojson }})" class="text-xs text-red-400 hover:text-red-300">Quitar</button>
                    </div>
                </div>
                {% endfor %}
                {% if not current_order.items %}
                <p id="no-items-message" class="text-gray-500 py-3">No hay ítems en este pedido.</p>
                {% endif %}
            </div>
            <div class="text-right mb-6">
                <p class="text-xl font-bold text-gray-100">Total: <span id="order-total">${{ "%.2f"|format(current_order.total_amount) }}</span></p>
            </div>
            <div class="flex flex-wrap gap-3 justify-end">
                <form action="{{ url_for('mozo.mark_order_paid', order_id=current_order.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
                    <button type="submit" class="btn btn-orange px-4 py-2">Marcar como Pagado</button>
                </form>
                <form action="{{ url_for('mozo.cancel_order', order_id=current_order.id) }}" method="POST" onsubmit="return confirm('¿Seguro que quieres cancelar este pedido?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
                    <button type="submit" class="btn btn-danger px-4 py-2">Cancelar Pedido</button>
                </form>
            </div>
        {% else %}
            <p class="text-gray-400 mb-4">Esta mesa está actualmente vacía.</p>
            <form action="{{ url_for('mozo.start_table_order', table_id=table.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}">
                <button type="submit" class="btn btn-orange px-4 py-2">Iniciar Nuevo Pedido</button>
            </form>
        {% endif %}
    </div>

    {% if current_order %}
    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4 text-gray-100">Añadir Productos</h2>
        <form id="add-item-form" class="space-y-4">
            <div>
                <label for="product_id" class="block text-sm font-medium text-gray-300">Producto</label>
                <select name="product_id" id="product_id" required class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                    <option value="">Selecciona un producto...</option>
                    {% for type, products_in_type in products_by_category.items() %}
                    <optgroup label="{{ type }}">
                        {% for product in products_in_type %}
                        <option value="{{ product.id }}" data-stock="{{ product.stock }}">{{ product.name }} - ${{ "%.2f"|format(product.price) }} (Stock: {{ product.stock }})</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-300">Cantidad</label>
                <input type="number" name="quantity" id="quantity" value="1" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
            </div>
            <button type="submit" class="w-full btn btn-orange px-4 py-2">Añadir al Pedido</button>
        </form>
        <div id="add-item-message" class="mt-3 text-sm"></div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.getElementById('csrf_token_js').value;

    function showJsMessage(message, type = 'info') {
        const messageDiv = document.getElementById('add-item-message');
        if (!messageDiv) return;
        messageDiv.textContent = message;
        messageDiv.className = 'p-3 my-3 text-sm rounded-md ';
        if (type === 'success') messageDiv.classList.add('bg-green-200', 'text-green-800', 'border', 'border-green-400');
        else messageDiv.classList.add('bg-red-200', 'text-red-800', 'border', 'border-red-400');
        setTimeout(() => { messageDiv.textContent = ''; messageDiv.className = 'mt-3 text-sm'; }, 4000);
    }

    function updateOrderView(item, newTotal) {
        const list = document.getElementById('order-items-list');
        const totalEl = document.getElementById('order-total');
        const noItemsMsg = document.getElementById('no-items-message');
        if (noItemsMsg) noItemsMsg.remove();

        let row = document.getElementById(`item-row-${item.id}`);
        if (row) {
            row.querySelector('.text-sm').textContent = `${item.quantity} x $${item.unit_price.toFixed(2)}`;
            row.querySelector('.text-right .font-medium').textContent = `$${item.subtotal.toFixed(2)}`;
        } else {
            row = document.createElement('div');
            row.id = `item-row-${item.id}`;
            row.className = 'py-3 flex justify-between items-center';
            row.innerHTML = `
                <div>
                    <p class="font-medium text-gray-100">${item.name}</p>
                    <p class="text-sm text-gray-400">${item.quantity} x $${item.unit_price.toFixed(2)}</p>
                </div>
                <div class="text-right">
                    <p class="font-medium text-gray-100">$${item.subtotal.toFixed(2)}</p>
                    <button onclick="removeItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')" class="text-xs text-red-400 hover:text-red-300">Quitar</button>
                </div>`;
            list.appendChild(row);
        }
        totalEl.textContent = `$${newTotal.toFixed(2)}`;
    }

    window.removeItem = function(itemId, itemName) {
        if (!confirm(`¿Seguro que quieres quitar ${itemName} del pedido?`)) return;
        const formData = new FormData();
        formData.append('csrf_token', csrfToken);
        fetch(`/mozo/order_item/${itemId}/remove`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`item-row-${itemId}`);
                if (row) row.remove();
                document.getElementById('order-total').textContent = `$${data.order_total.toFixed(2)}`;
                showJsMessage(data.message, 'success');
                const list = document.getElementById('order-items-list');
                if (!list.querySelector('div[id^="item-row-"]')) {
                    list.innerHTML = '<p id="no-items-message" class="text-gray-500 py-3">No hay ítems en este pedido.</p>';
                }
            } else { showJsMessage(data.message, 'error'); }
        });
    }
    
    const addItemForm = document.getElementById('add-item-form');
    if (addItemForm) {
        addItemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append('csrf_token', csrfToken);
            const fetchUrl = `{{ url_for('mozo.add_item_to_order', order_id=(current_order.id if current_order else 0)) }}`;
            fetch(fetchUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateOrderView(data.item, data.order_total);
                    showJsMessage(data.message, 'success');
                    this.reset();
                    document.getElementById('quantity').value = 1;
                } else { showJsMessage(data.message, 'error'); }
            });
        });
    }
});
</script>
{% endblock %}